<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contracts ä¸€è¦§ | Fellowship Style</title>
  <style>
    :root {
      --primary-blue: #4eb1e9;
      --hover-blue: #3a9dd4;
      --bg-color: #f9fbfe;
      --text-main: #333;
      --text-sub: #666;
      --border-color: #e1e8ed;
      --card-bg: #ffffff;
      --border-thick: 2px;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 24px;
      line-height: 1.6;
    }

    h1 {
      font-size: 24px;
      color: var(--text-main);
      margin: 0 0 4px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    #source {
      color: var(--text-sub);
      font-size: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
    }
    #source::before {
      content: "";
      display: inline-block;
      width: 12px;
      height: 2px;
      background: var(--primary-blue);
      margin-right: 8px;
    }

    .quick-links { margin-bottom: 30px; }
    .quick-links__title {
      font-size: 14px;
      margin-bottom: 12px;
      color: var(--text-main);
      font-weight: 700;
      border-left: 4px solid var(--primary-blue);
      padding-left: 10px;
    }
    .quick-links__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .quick-link {
      display: flex;
      align-items: center;
      padding: 14px;
      border: var(--border-thick) solid var(--border-color);
      border-radius: 12px;
      background: var(--card-bg);
      text-decoration: none;
      color: var(--text-main);
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .quick-link:hover {
      border-color: var(--primary-blue);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(78, 177, 233, 0.15);
    }
    .quick-link__visual {
      width: 44px;
      height: 44px;
      background-color: #ffffff;
      border: var(--border-thick) solid var(--border-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      margin-right: 14px;
      flex-shrink: 0;
      transition: border-color 0.2s;
    }
    .quick-link:hover .quick-link__visual { border-color: var(--primary-blue); }
    .quick-link__body { flex-grow: 1; }
    .quick-link__label { font-size: 13px; font-weight: 700; display: block; }
    .quick-link__hint { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .quick-link__arrow { font-size: 12px; color: var(--primary-blue); margin-left: 8px; opacity: 0.6; }

    .card {
      background: var(--card-bg);
      border: var(--border-thick) solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 20px;
      font-size: 16px;
      color: var(--text-main);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .field { display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 12px; font-weight: 700; color: var(--text-sub); }
    input, select, textarea {
      padding: 10px 14px;
      font-size: 14px;
      border: var(--border-thick) solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-blue); }

    button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      border: var(--border-thick) solid var(--border-color);
      background: #fff;
      transition: all 0.2s;
    }
    button.primary {
      background: var(--primary-blue);
      border-color: var(--primary-blue);
      color: #fff;
    }
    button.primary:hover { background: var(--hover-blue); border-color: var(--hover-blue); }
    button.danger {
      background: #fff;
      border-color: #f3b8b8;
      color: #d93025;
    }
    button.danger:hover {
      background: #fff5f5;
      border-color: #d93025;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    #status { color: var(--text-sub); margin: 16px 0 8px; font-size: 13px; }
    .error { color: #d93025; }

    .table-wrapper {
      overflow: auto;
      background: #fff;
      border-radius: 12px;
      border: var(--border-thick) solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 1180px; /* è»¢è¨˜ç”¨åˆ—ã¶ã‚“å°‘ã—åºƒã’ã‚‹ */
      table-layout: fixed;
    }

    th {
      background: var(--primary-blue);
      color: #ffffff;
      padding: 14px 16px;
      border-bottom: var(--border-thick) solid rgba(0,0,0,0.05);
      font-size: 13px;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background-color: #f4faff; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      background: #eee;
      color: #666;
      white-space: nowrap;
    }
    .badge-ok {
      background: #e1f5fe;
      color: var(--primary-blue);
      border: 1px solid var(--primary-blue);
    }

    .mt14 { margin-top: 24px; }

    .mini {
      font-size: 12px;
      color: var(--text-sub);
      font-weight: 700;
    }

    .td-actions {
      display:flex;
      align-items:center;
      gap:10px;
      white-space: nowrap;
    }

    .chk {
      width: 18px;
      height: 18px;
      transform: translateY(1px);
    }

    .toolbar {
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap: wrap;
    }

    .unitup-select {
      min-width: 84px;
      padding: 8px 10px;
      font-weight: 700;
    }

    th.unit-col,
    td.unit-col{
      text-align: center;
      padding-left: 0;
      padding-right: 0;
      white-space: nowrap;
    }
    td.unit-col .unit-num{
      display: block;
      width: 100%;
      text-align: center;
      font-weight: 700;
      white-space: nowrap;
    }

    /* ===== è»¢è¨˜ç”¨ï¼šè¦‹ãŸç›®ã¯çœç•¥ã—ã¦OKã€‚ã§ã‚‚ã‚³ãƒ”ãƒ¼ã¯ãƒœã‚¿ãƒ³ã§å…¨æ–‡ ===== */
    td.transfer-col { }
    .transfer-wrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0; /* çœç•¥ãŒåŠ¹ã */
    }
    .transfer-text{
      flex:1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .copy-mini{
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: #fff;
      cursor: pointer;
      font-weight: 700;
    }
    .copy-mini:hover{
      border-color: var(--primary-blue);
      color: var(--primary-blue);
    }

    .modal-backdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modal{
      width: min(520px, 100%);
      background:#fff;
      border-radius: 16px;
      border: 1px solid #e5e5e5;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
      padding: 16px;
    }
    .modal h2{ margin:0 0 6px; font-size:16px; }
    .modal p{ margin:0 0 12px; font-size:12px; color:#666; line-height:1.6; }
    .modal .modal-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .modal .modal-row .grow{ flex:1; min-width: 220px; }
    .modal .footer{ display:flex; gap:10px; justify-content:flex-end; margin-top: 14px; flex-wrap:wrap; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 20px;
      transform: translateX(-50%);
      background: rgba(30,30,30,0.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-size: 13px;
      display:none;
      z-index: 10000;
    }

    /* å˜ä¾¡åˆ—ï¼ˆè¦‹ãŸç›®èª¿æ•´ï¼‰ */
    #reqTable th:nth-child(6),
    #reqTable td:nth-child(6){
      text-align: left !important;
      white-space: nowrap;
      width: 120px;
    }
    td.unit-col{
      text-align: left !important;
      padding-left: 16px !important;
      padding-right: 16px !important;
    }

    td.unit-col .unit-num{
      display: inline !important;
      width: auto !important;
      text-align: left !important;
    }
    #reqTable td:nth-child(6){
      text-align: left !important;
    }

    #reqTable td:nth-child(6) .unit-num{
      display: inline-block !important;
      width: auto !important;
      text-align: left !important;
    }
    #reqTable th:nth-child(6){
      padding-left: 28px;
    }
  </style>
</head>

<body>

  <section class="quick-links" aria-label="å¸¸è¨­ãƒªãƒ³ã‚¯">
    <h2 class="quick-links__title">ã‚ˆãä½¿ã†ãƒªãƒ³ã‚¯</h2>
    <div id="quickLinks" class="quick-links__grid"></div>
  </section>

  <h1>Contracts</h1>
  <div id="source">ãƒ‡ãƒ¼ã‚¿å…ƒï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€ŒContractsã€</div>

  <div class="card">
    <div class="card-title">æ–°è¦ç™»éŒ²</div>
    <div class="row">
      <div class="field">
        <label for="staffName">â‘  ã‚¹ã‚¿ãƒƒãƒ•æ°å</label>
        <input id="staffName" type="text" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ" />
      </div>

      <div class="field">
        <label for="contractEnd">â‘¡ å¥‘ç´„çµ‚äº†æ—¥</label>
        <input id="contractEnd" type="date" />
      </div>

      <div class="field">
        <label for="templateTypeRegister">â‘¢ ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥</label>
        <select id="templateTypeRegister">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å¥‘ç´„æ›´æ–°">å¥‘ç´„æ›´æ–°</option>
          <option value="å˜ä¾¡å¤‰æ›´">å˜ä¾¡å¤‰æ›´</option>
          <option value="æƒ…å ±å¤‰æ›´">æƒ…å ±å¤‰æ›´</option>
          <option value="ã‚¹ã‚¿ãƒƒãƒ•æ¡ˆå†…">ã‚¹ã‚¿ãƒƒãƒ•æ¡ˆå†…</option>
          <option value="ã‚¹ã‚¿ãƒƒãƒ•é€£çµ¡">ã‚¹ã‚¿ãƒƒãƒ•é€£çµ¡</option>
          <option value="è»¢è¨˜ç”¨">è»¢è¨˜ç”¨</option>
        </select>
      </div>

      <button id="registerBtn" class="primary">ç™»éŒ²</button>
      <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
    </div>
    <div id="formMsg" style="margin-top:12px; font-size:12px; font-weight:700;"></div>
  </div>

  <div class="card">
    <div class="card-title">
      <span>æœªå®Œäº†ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</span>
      <div class="toolbar">
        <span class="mini">ãƒã‚§ãƒƒã‚¯ã—ãŸè¡Œã‚’ä¸€æ‹¬ã§éè¡¨ç¤ºï¼ˆå®Œäº†ï¼‰</span>
        <button id="bulkCompleteBtn" class="danger" disabled>å‰Šé™¤</button>
      </div>
    </div>

    <div id="status">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>

    <div class="table-wrapper">
      <table id="reqTable"></table>
    </div>
  </div>

  <div class="card mt14">
    <div class="card-title">ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆãã®å ´ã§ã‚³ãƒ”ãƒšç”¨ï¼‰</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
      <div class="field">
        <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥</label>
        <select id="templateType" style="width:100%;">
          <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
      </div>
      <div class="field">
        <label for="templateKey">ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠ</label>
        <select id="templateKey" style="width:100%;">
          <option value="">ï¼ˆã¾ãšç¨®åˆ¥ã‚’é¸æŠï¼‰</option>
        </select>
      </div>
    </div>
    <div class="field" style="margin-top:16px;">
      <label for="templateBody">æ–‡é¢ï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</label>
      <textarea id="templateBody" rows="8" style="width:100%; box-sizing:border-box; resize: vertical;" readonly>ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰</textarea>
    </div>
    <button id="copyBtn" class="primary" style="width:100%; margin-top:16px; padding: 14px;">
      ã“ã®æ–‡é¢ã‚’ã‚³ãƒ”ãƒ¼
    </button>
  </div>

  <script>
    function esc(v) {
      return String(v ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function fmtDateOnly(v) { return v ? esc(String(v).slice(0, 10)) : ""; }
    function fmtDateTime(v) {
      if (!v) return "";
      const s = String(v);
      return esc(s.replace("T", " ").slice(0, 16));
    }
    function fmtNumber(v){
      if (v === null || v === undefined || v === "") return "";
      const n = Number(String(v).replace(/,/g, "").trim());
      if (!Number.isFinite(n)) return esc(v);
      return esc(n.toLocaleString("ja-JP"));
    }

    function setStatus(message, isError) {
      const el = document.getElementById("status");
      el.classList.toggle("error", !!isError);
      el.textContent = message || "";
    }
    function setFormMsg(message, isError) {
      const el = document.getElementById("formMsg");
      el.style.color = isError ? "#d93025" : "#008a32";
      el.textContent = message || "";
    }
    function badge(text, ok) { return `<span class="${ok ? "badge badge-ok" : "badge"}">${esc(text)}</span>`; }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=> t.style.display='none', 1800);
    }

    const UNITUP_OPTIONS = ["æœª", "ã€‡", "Ã—"];

    const ICON_BY_LABEL = [
      { re: /å¥‘ç´„|æ›´æ–°|ã‚¹ãƒ—ã‚·/i, icon: "ğŸ“‹", hint: "æ›´æ–°ã®ç¢ºèª" },
      { re: /ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³|çŠ¶æ³/i, icon: "ğŸ“ˆ", hint: "çŠ¶æ³ãƒã‚§ãƒƒã‚¯" },
      { re: /ãƒã‚§ãƒƒã‚¯|ãƒªã‚¹ãƒˆ|æ‰‹ç¶šã/i, icon: "âœ…", hint: "æ‰‹ç¶šãæ‰‹é †" },
      { re: /slack|ã‚¹ãƒ©ãƒƒã‚¯|SW/i, icon: "ğŸ’¬", hint: "é€£çµ¡" },
      { re: /chat|ãƒãƒ£ãƒƒãƒˆ/i, icon: "ğŸ—¨ï¸", hint: "é€£çµ¡" },
      { re: /mail|ãƒ¡ãƒ¼ãƒ«/i, icon: "âœ‰ï¸", hint: "Gmail" },
      { re: /ãƒ•ã‚©ãƒ­ãƒ¼|follow/i, icon: "ğŸ‘¤", hint: "ãƒ•ã‚©ãƒ­ãƒ¼å°ç·š" },
      { re: /ãƒ€ãƒƒã‚·ãƒ¥|dashboard/i, icon: "ğŸ“Š", hint: "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" },
      { re: /notebook/i, icon: "ğŸ““", hint: "ãƒãƒ¼ãƒˆ" },
    ];
    function pickIconHint_(label) {
      const s = String(label ?? "");
      for (const it of ICON_BY_LABEL) {
        if (it.re.test(s)) return { icon: it.icon, hint: it.hint };
      }
      return { icon: "ğŸ”—", hint: "" };
    }

    function renderQuickLinks_(res) {
      const wrap = document.getElementById("quickLinks");
      wrap.innerHTML = "";
      if (!res || res.error) {
        wrap.innerHTML = `<div style="color:#d93025; font-size:12px; font-weight:700;">ãƒªãƒ³ã‚¯å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
        return;
      }
      const links = Array.isArray(res.links) ? res.links : [];
      if (links.length === 0) {
        wrap.innerHTML = `<div style="color:#666; font-size:12px; font-weight:700;">ãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆLinksã‚·ãƒ¼ãƒˆã‚’ç¢ºèªï¼‰</div>`;
        return;
      }
      wrap.innerHTML = links.map((l) => {
        const meta = pickIconHint_(l.label);
        const url = esc(l.url);
        const label = esc(l.label);
        const hint = esc(meta.hint ?? "");
        const icon = esc(meta.icon ?? "ğŸ”—");
        return `
          <a class="quick-link" href="${url}" target="_blank" rel="noopener noreferrer">
            <div class="quick-link__visual">${icon}</div>
            <div class="quick-link__body">
              <span class="quick-link__label">${label}</span>
              <div class="quick-link__hint">${hint}</div>
            </div>
            <span class="quick-link__arrow" aria-hidden="true">â†—</span>
          </a>
        `;
      }).join("");
    }

    function loadQuickLinks_() {
      google.script.run
        .withSuccessHandler(renderQuickLinks_)
        .withFailureHandler(() => renderQuickLinks_({ links: [], error: "failed" }))
        .getLinksData();
    }

    let CURRENT_ROWS = [];
    let SELECTED = new Set();
    let gModalTarget = null;

    function openReflectModal(rowNumber, staffName){
      gModalTarget = { rowNumber, staffName: staffName || "" };
      document.getElementById("modalStaffName").textContent = gModalTarget.staffName || "-";
      document.getElementById("reflectDateInput").value = "";
      document.getElementById("unitInput").value = "";
      document.getElementById("modalBackdrop").style.display = "flex";
      document.getElementById("unitInput").focus();
    }
    function closeReflectModal(){
      document.getElementById("modalBackdrop").style.display = "none";
      gModalTarget = null;
    }

    function toObjects(headers, rows, rowNumbers) {
      const idx = Object.fromEntries(headers.map((h, i) => [h, i]));
      return rows.map((r, k) => ({
        rowNumber: Array.isArray(rowNumbers) ? rowNumbers[k] : null,
        staffName: r[idx["ã‚¹ã‚¿ãƒƒãƒ•å"]],
        contractEnd: r[idx["å¥‘ç´„çµ‚äº†æ—¥"]],
        templateType: r[idx["ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥"]],
        raiseRealized: r[idx["å˜ä¾¡UPå®Ÿç¾"]],
        unit: r[idx["å˜ä¾¡"]],
        transferText: r[idx["è»¢è¨˜ç”¨"]],
        registeredAt: r[idx["ç™»éŒ²æ—¥æ™‚"]],
      }));
    }

    function updateBulkButton_() {
      const btn = document.getElementById("bulkCompleteBtn");
      btn.disabled = SELECTED.size === 0;
      btn.textContent = SELECTED.size === 0 ? "å‰Šé™¤" : `å‰Šé™¤(${SELECTED.size})`;
    }

    function normalizeUnitUp_(v) {
      const s = String(v ?? "").trim();
      if (UNITUP_OPTIONS.includes(s)) return s;
      if (s === "å®Ÿç¾" || s.toLowerCase() === "true") return "ã€‡";
      return "æœª";
    }

    function buildUnitUpSelect_(rowNumber, currentValue) {
      const cur = normalizeUnitUp_(currentValue);
      const opts = UNITUP_OPTIONS
        .map(v => `<option value="${esc(v)}" ${v === cur ? "selected" : ""}>${esc(v)}</option>`)
        .join("");
      return `<select class="unitup-select" data-act="unitup" data-row="${esc(rowNumber)}">${opts}</select>`;
    }

    function findItemByRowNumber_(rowNumber){
      return (CURRENT_ROWS || []).find(x => Number(x.rowNumber) === Number(rowNumber)) || null;
    }

    async function copyText_(text){
      const s = String(text ?? "");
      if (!s.trim()) { toast("ã‚³ãƒ”ãƒ¼ã™ã‚‹æ–‡å­—ãŒãªã„ã‚ˆ"); return; }
      try {
        await navigator.clipboard.writeText(s);
        toast("è»¢è¨˜ç”¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
      } catch (e) {
        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ãŒä½¿ãˆãªã„ç’°å¢ƒã®ä¿é™º
        try {
          const ta = document.createElement("textarea");
          ta.value = s;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          document.body.appendChild(ta);
          ta.select();
          document.execCommand("copy");
          document.body.removeChild(ta);
          toast("è»¢è¨˜ç”¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
        } catch (_e2) {
          alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }
      }
    }

    function renderRequirementTable(items) {
      const table = document.getElementById("reqTable");

      const colgroup = `
        <colgroup>
          <col style="width:56px;">
          <col style="width:160px;">
          <col style="width:120px;">
          <col style="width:120px;">
          <col style="width:100px;">
          <col style="width:110px;">
          <col style="width:320px;">  <!-- è»¢è¨˜ç”¨ -->
          <col style="width:160px;">
          <col style="width:170px;">  <!-- æ“ä½œ -->
        </colgroup>
      `;

      const thead = `
        <thead>
          <tr>
            <th>å®Œäº†</th>
            <th>ã‚¹ã‚¿ãƒƒãƒ•å</th>
            <th>å¥‘ç´„çµ‚äº†æ—¥</th>
            <th>ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥</th>
            <th>å˜ä¾¡UPå®Ÿç¾</th>
            <th class="unit-col">å˜ä¾¡</th>
            <th>è»¢è¨˜ç”¨</th>
            <th>ç™»éŒ²æ—¥æ™‚</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
      `;

      if (!items || items.length === 0) {
        table.innerHTML = colgroup + thead + `<tbody><tr><td colspan="9">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr></tbody>`;
        SELECTED.clear();
        updateBulkButton_();
        return;
      }

      const tbodyRows = items.map(it => {
        const staff = it.staffName ? esc(it.staffName) : badge("æœªè¨­å®š", false);
        const tmpl  = it.templateType ? esc(it.templateType) : badge("æœªè¨­å®š", false);
        const rn = it.rowNumber;
        const checked = rn && SELECTED.has(rn) ? "checked" : "";
        const unitUpSelect = rn ? buildUnitUpSelect_(rn, it.raiseRealized) : badge("æœª", false);
        const unitText = fmtNumber(it.unit);

        const transferRaw = String(it.transferText ?? "");
        const transferShown = esc(transferRaw);
        const transferCell = `
          <div class="transfer-wrap">
            <div class="transfer-text" title="${esc(transferRaw)}">${transferShown}</div>
            <button class="copy-mini" data-act="copy-transfer" data-row="${esc(rn)}" type="button">ã‚³ãƒ”ãƒ¼</button>
          </div>
        `;

        return `
          <tr data-row="${esc(rn)}">
            <td>
              <input class="chk" type="checkbox" ${checked} data-row="${esc(rn)}" aria-label="å®Œäº†å¯¾è±¡ã«ã™ã‚‹">
            </td>
            <td style="font-weight:700;">${staff}</td>
            <td>${fmtDateOnly(it.contractEnd)}</td>
            <td>${tmpl}</td>
            <td>${unitUpSelect}</td>
            <td class="unit-col"><span class="unit-num">${unitText}</span></td>
            <td class="transfer-col">${transferCell}</td>
            <td>${fmtDateTime(it.registeredAt)}</td>
            <td class="td-actions">
              <button class="danger" data-act="complete-one" data-row="${esc(rn)}">å‰Šé™¤</button>
            </td>
          </tr>
        `;
      }).join("");

      table.innerHTML = colgroup + thead + `<tbody>${tbodyRows}</tbody>`;

      table.querySelectorAll('input[type="checkbox"][data-row]').forEach(chk => {
        chk.addEventListener("change", (ev) => {
          const rn = Number(ev.target.getAttribute("data-row"));
          if (!rn) return;
          if (ev.target.checked) SELECTED.add(rn);
          else SELECTED.delete(rn);
          updateBulkButton_();
        });
      });

      table.querySelectorAll('button[data-act="complete-one"]').forEach(btn => {
        btn.addEventListener("click", () => {
          const rn = Number(btn.getAttribute("data-row"));
          if (rn) completeOne_(rn);
        });
      });

      table.querySelectorAll('select[data-act="unitup"][data-row]').forEach(sel => {
        sel.addEventListener("change", (ev) => {
          const rn = Number(ev.target.getAttribute("data-row"));
          const val = ev.target.value;
          if (rn) saveUnitUp_(rn, val, ev.target);
        });
      });

      table.querySelectorAll('button[data-act="copy-transfer"][data-row]').forEach(btn => {
        btn.addEventListener("click", async () => {
          const rn = Number(btn.getAttribute("data-row"));
          const item = findItemByRowNumber_(rn);
          await copyText_(item?.transferText ?? "");
        });
      });

      updateBulkButton_();
    }

    function loadRequirementList() {
      setStatus("æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...", false);
      google.script.run
        .withSuccessHandler((res) => {
          if (!res || res.error) { setStatus(res?.error || "å–å¾—ã‚¨ãƒ©ãƒ¼", true); return; }
          const items = toObjects(res.headers || [], res.rows || [], res.rowNumbers || []);
          CURRENT_ROWS = items;
          SELECTED.clear();
          renderRequirementTable(items);
          setStatus("æœ€çµ‚æ›´æ–°: " + new Date().toLocaleTimeString(), false);
        })
        .withFailureHandler(() => setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼", true))
        .getContractsData();
    }

    function setRegisterBusy(isBusy) {
      ["registerBtn", "reloadBtn", "staffName", "contractEnd", "templateTypeRegister", "bulkCompleteBtn"]
        .forEach(id => document.getElementById(id).disabled = isBusy);
      document.querySelectorAll('select[data-act="unitup"], button[data-act="complete-one"], input[type="checkbox"], button[data-act="copy-transfer"]')
        .forEach(el => el.disabled = isBusy);
    }

    function handleRegister() {
      const staffName = document.getElementById("staffName").value.trim();
      const contractEnd = document.getElementById("contractEnd").value;
      const templateType = document.getElementById("templateTypeRegister").value;
      if (!staffName || !contractEnd || !templateType) { setFormMsg("å…¥åŠ›ä¸è¶³ãŒã‚ã‚Šã¾ã™", true); return; }

      setRegisterBusy(true);
      setFormMsg("ç™»éŒ²ä¸­...", false);
      google.script.run
        .withSuccessHandler(() => {
          setFormMsg("ç™»éŒ²ã•ã‚Œã¾ã—ãŸ", false);
          ["staffName", "contractEnd", "templateTypeRegister"].forEach(id => document.getElementById(id).value = "");
          loadRequirementList();
          setRegisterBusy(false);
        })
        .withFailureHandler((e) => {
          setFormMsg("ç™»éŒ²å¤±æ•—: " + (e?.message || ""), true);
          setRegisterBusy(false);
        })
        .addContract(staffName, contractEnd, templateType);
    }

    function findStaffNameByRowNumber_(rowNumber){
      const it = findItemByRowNumber_(rowNumber);
      return it?.staffName ? String(it.staffName) : "";
    }

    function saveUnitUp_(rowNumber, value, selectEl) {
      const prev = selectEl.getAttribute("data-prev") || normalizeUnitUp_(selectEl.value);
      selectEl.disabled = true;
      setStatus("å˜ä¾¡UPå®Ÿç¾ã‚’ä¿å­˜ä¸­...", false);
      google.script.run
        .withSuccessHandler(() => {
          selectEl.setAttribute("data-prev", value);
          selectEl.disabled = false;
          setStatus("ä¿å­˜ã—ã¾ã—ãŸ: " + new Date().toLocaleTimeString(), false);
          if (String(value).trim() === "ã€‡") {
            const staff = findStaffNameByRowNumber_(rowNumber);
            openReflectModal(rowNumber, staff);
          } else {
            loadRequirementList();
          }
        })
        .withFailureHandler((e) => {
          selectEl.value = prev;
          selectEl.disabled = false;
          setStatus("ä¿å­˜ã«å¤±æ•—: " + (e?.message || ""), true);
        })
        .setUnitUpByRow(rowNumber, value);
    }

    function completeOne_(rowNumber) {
      if (!confirm("ã“ã®è¡Œã‚’å®Œäº†ï¼ˆéè¡¨ç¤ºï¼‰ã«ã—ã¾ã™ã‹ï¼Ÿ")) return;
      setRegisterBusy(true);
      setStatus("å®Œäº†å‡¦ç†ä¸­...", false);
      google.script.run
        .withSuccessHandler(() => {
          setStatus("å®Œäº†ã«ã—ã¾ã—ãŸï¼ˆéè¡¨ç¤ºï¼‰", false);
          loadRequirementList();
          setRegisterBusy(false);
        })
        .withFailureHandler((e) => {
          setStatus("å®Œäº†å‡¦ç†ã«å¤±æ•—: " + (e?.message || ""), true);
          setRegisterBusy(false);
        })
        .completeContractByRow(rowNumber);
    }

    function completeBulk_() {
      const rows = Array.from(SELECTED.values());
      if (rows.length === 0) return;
      if (!confirm(`ãƒã‚§ãƒƒã‚¯ã—ãŸ ${rows.length} ä»¶ã‚’å®Œäº†ï¼ˆéè¡¨ç¤ºï¼‰ã«ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      setRegisterBusy(true);
      setStatus("ä¸€æ‹¬å®Œäº†å‡¦ç†ä¸­...", false);
      google.script.run
        .withSuccessHandler(() => {
          setStatus("ä¸€æ‹¬å®Œäº†ã—ã¾ã—ãŸ", false);
          loadRequirementList();
          setRegisterBusy(false);
        })
        .withFailureHandler((e) => {
          setStatus("ä¸€æ‹¬å®Œäº†ã«å¤±æ•—: " + (e?.message || ""), true);
          setRegisterBusy(false);
        })
        .completeContractsByRows(rows);
    }

    // ====== Templates ======
    let TEMPLATE_LIST = [];

    function resetTemplateUI_() {
      document.getElementById("templateKey").innerHTML = '<option value="">ï¼ˆã¾ãšç¨®åˆ¥ã‚’é¸æŠï¼‰</option>';
      document.getElementById("templateBody").value = "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰";
    }

    function getUniqueTypes_() {
      const types = new Set();
      (TEMPLATE_LIST || []).forEach(t => {
        const s = String(t?.template_type ?? "").trim();
        if (s) types.add(s);
      });
      return Array.from(types);
    }

    function renderTemplateTypeOptions_() {
      const typeSel = document.getElementById("templateType");
      const types = getUniqueTypes_();

      if (types.length === 0) {
        typeSel.innerHTML = '<option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãŒã‚ã‚Šã¾ã›ã‚“</option>';
        return;
      }

      typeSel.innerHTML =
        '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
        types.map(tp => `<option value="${esc(tp)}">${esc(tp)}</option>`).join("");
    }

    function getTemplatesByType_(typeLabel) {
      const key = String(typeLabel ?? "").trim();
      return (TEMPLATE_LIST || []).filter(t => String(t?.template_type ?? "").trim() === key);
    }

    function renderTemplateKeyOptionsByType_(typeLabel) {
      const keySel  = document.getElementById("templateKey");
      const bodyEl  = document.getElementById("templateBody");

      const list = getTemplatesByType_(typeLabel);

      keySel.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
        list.map((t, i) => `<option value="${esc(String(i))}">${esc(t.label)}</option>`).join("");

      bodyEl.value = "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰";
    }

    function loadTemplates_() {
      google.script.run
        .withSuccessHandler((res) => {
          TEMPLATE_LIST = Array.isArray(res?.templates) ? res.templates : [];
          renderTemplateTypeOptions_();
          resetTemplateUI_();
        })
        .withFailureHandler(() => {
          TEMPLATE_LIST = [];
          renderTemplateTypeOptions_();
          resetTemplateUI_();
        })
        .getTemplatesData();
    }

    window.addEventListener("DOMContentLoaded", () => {
      const typeSel = document.getElementById("templateType");
      const keySel  = document.getElementById("templateKey");
      const bodyEl  = document.getElementById("templateBody");
      const copyBtn = document.getElementById("copyBtn");

      typeSel.addEventListener("change", () => {
        const typeLabel = typeSel.value;
        if (!typeLabel) { resetTemplateUI_(); return; }
        renderTemplateKeyOptionsByType_(typeLabel);
      });

      keySel.addEventListener("change", () => {
        const typeLabel = typeSel.value;
        const list = getTemplatesByType_(typeLabel);
        const idx = Number(keySel.value);
        const tmpl = (Number.isInteger(idx) && idx >= 0) ? list[idx] : null;
        bodyEl.value = tmpl ? (tmpl.body ?? "") : "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰";
      });

      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(bodyEl.value);
          const txt = copyBtn.textContent;
          copyBtn.textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
          setTimeout(() => copyBtn.textContent = txt, 1500);
        } catch (e) { alert("ã‚³ãƒ”ãƒ¼å¤±æ•—"); }
      });

      document.getElementById("reloadBtn").addEventListener("click", loadRequirementList);
      document.getElementById("registerBtn").addEventListener("click", handleRegister);
      document.getElementById("bulkCompleteBtn").addEventListener("click", completeBulk_);
      document.getElementById("modalCancelBtn").addEventListener("click", () => { closeReflectModal(); loadRequirementList(); });

      document.getElementById("modalSaveBtn").addEventListener("click", () => {
        if (!gModalTarget) return;
        const ymd = String(document.getElementById("reflectDateInput").value || "").trim();
        const unitVal = String(document.getElementById("unitInput").value || "").trim();
        if (!ymd || !unitVal) { toast("åæ˜ æ—¥ã¨å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ã­"); return; }
        setStatus("åæ˜ æ—¥ï¼‹å˜ä¾¡ã‚’ä¿å­˜ä¸­...", false);
        google.script.run
          .withSuccessHandler(() => {
            toast("åæ˜ æ—¥ï¼‹å˜ä¾¡ã‚’ä¿å­˜");
            closeReflectModal();
            loadRequirementList();
          })
          .withFailureHandler((err) => {
            setStatus("ä¿å­˜å¤±æ•—: " + (err?.message || err), true);
            toast("ä¿å­˜ã‚¨ãƒ©ãƒ¼");
          })
          .setUnitUpReflectAndUnitByRow(gModalTarget.rowNumber, ymd, unitVal);
      });

      document.getElementById("modalBackdrop").addEventListener("click", (e) => {
        if (e.target === document.getElementById("modalBackdrop")) {
          closeReflectModal();
          loadRequirementList();
        }
      });

      loadQuickLinks_();
      loadRequirementList();
      loadTemplates_();
    });
  </script>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h2>å˜ä¾¡UP åæ˜ æ—¥ãƒ»å˜ä¾¡ã‚’å…¥åŠ›</h2>
      <p>å˜ä¾¡UPå®Ÿç¾ãŒã€Œã€‡ã€ã®ãŸã‚ã€åæ˜ æ—¥ã¨å˜ä¾¡ã‚’ä¿å­˜ã—ã¾ã™ã€‚</p>
      <div class="modal-row">
        <div class="grow">
          <label>åæ˜ æ—¥ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</label>
          <input type="date" id="reflectDateInput" />
        </div>
        <div class="grow">
          <label>å˜ä¾¡ï¼ˆæ•°å€¤ï¼‰</label>
          <input type="text" id="unitInput" inputmode="numeric" placeholder="ä¾‹ï¼‰650000 / 3200" />
        </div>
        <div class="grow">
          <label>å¯¾è±¡ã‚¹ã‚¿ãƒƒãƒ•</label>
          <div style="font-weight:700; padding:10px 0;" id="modalStaffName">-</div>
        </div>
      </div>
      <div class="footer">
        <button class="btn secondary" id="modalCancelBtn" type="button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn primary" id="modalSaveBtn" type="button">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

</body>
</html>
