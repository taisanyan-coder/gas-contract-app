<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Contracts ä¸€è¦§ | Fellowship Style</title>
  <style>
    :root {
      --primary-blue: #4eb1e9;
      --hover-blue: #3a9dd4;
      --bg-color: #f9fbfe;
      --text-main: #333;
      --text-sub: #666;
      --border-color: #e1e8ed;
      --card-bg: #ffffff;
      --border-thick: 2px;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 24px;
      line-height: 1.6;
    }

    h1 {
      font-size: 24px;
      color: var(--text-main);
      margin: 0 0 4px;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    #source {
      color: var(--text-sub);
      font-size: 12px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
    }
    #source::before {
      content: "";
      display: inline-block;
      width: 12px;
      height: 2px;
      background: var(--primary-blue);
      margin-right: 8px;
    }

    .quick-links { margin-bottom: 30px; }
    .quick-links__title {
      font-size: 14px;
      margin-bottom: 12px;
      color: var(--text-main);
      font-weight: 700;
      border-left: 4px solid var(--primary-blue);
      padding-left: 10px;
    }
    .quick-links__grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }
    .quick-link {
      display: flex;
      align-items: center;
      padding: 14px;
      border: var(--border-thick) solid var(--border-color);
      border-radius: 12px;
      background: var(--card-bg);
      text-decoration: none;
      color: var(--text-main);
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.02);
    }
    .quick-link:hover {
      border-color: var(--primary-blue);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(78, 177, 233, 0.15);
    }
    .quick-link__visual {
      width: 44px;
      height: 44px;
      background-color: #ffffff;
      border: var(--border-thick) solid var(--border-color);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      margin-right: 14px;
      flex-shrink: 0;
      transition: border-color 0.2s;
    }
    .quick-link:hover .quick-link__visual { border-color: var(--primary-blue); }
    .quick-link__body { flex-grow: 1; }
    .quick-link__label { font-size: 13px; font-weight: 700; display: block; }
    .quick-link__hint { font-size: 11px; color: var(--text-sub); margin-top: 2px; }
    .quick-link__arrow { font-size: 12px; color: var(--primary-blue); margin-left: 8px; opacity: 0.6; }

    .card {
      background: var(--card-bg);
      border: var(--border-thick) solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .card-title {
      font-weight: 700;
      margin-bottom: 20px;
      font-size: 16px;
      color: var(--text-main);
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: flex-end;
    }
    .field { display: flex; flex-direction: column; gap: 8px; }
    label { font-size: 12px; font-weight: 700; color: var(--text-sub); }
    input, select, textarea {
      padding: 10px 14px;
      font-size: 14px;
      border: var(--border-thick) solid var(--border-color);
      border-radius: 6px;
      background: #fff;
      outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--primary-blue); }

    button {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      border-radius: 6px;
      border: var(--border-thick) solid var(--border-color);
      background: #fff;
      transition: all 0.2s;
    }
    button.primary {
      background: var(--primary-blue);
      border-color: var(--primary-blue);
      color: #fff;
    }
    button.primary:hover { background: var(--hover-blue); border-color: var(--hover-blue); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    #status { color: var(--text-sub); margin: 16px 0 8px; font-size: 13px; }
    .error { color: #d93025; }

    .table-wrapper {
      overflow: auto;
      background: #fff;
      border-radius: 12px;
      border: var(--border-thick) solid var(--border-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    table { border-collapse: collapse; width: 100%; min-width: 760px; }
    th {
      background: var(--primary-blue);
      color: #ffffff;
      padding: 14px 16px;
      border-bottom: var(--border-thick) solid rgba(0,0,0,0.05);
      font-size: 13px;
      text-align: left;
    }
    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background-color: #f4faff; }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      background: #eee;
      color: #666;
    }
    .badge-ok {
      background: #e1f5fe;
      color: var(--primary-blue);
      border: 1px solid var(--primary-blue);
    }

    .mt14 { margin-top: 24px; }
  </style>
</head>

<body>

  <section class="quick-links" aria-label="å¸¸è¨­ãƒªãƒ³ã‚¯">
    <h2 class="quick-links__title">ã‚ˆãä½¿ã†ãƒªãƒ³ã‚¯</h2>
    <div id="quickLinks" class="quick-links__grid"></div>
  </section>

  <h1>Contracts</h1>
  <div id="source">ãƒ‡ãƒ¼ã‚¿å…ƒï¼šã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã€ŒContractsã€</div>

  <div class="card">
    <div class="card-title">æ–°è¦ç™»éŒ²</div>
    <div class="row">
      <div class="field">
        <label for="staffName">â‘  ã‚¹ã‚¿ãƒƒãƒ•æ°å</label>
        <input id="staffName" type="text" placeholder="ä¾‹ï¼‰å±±ç”° å¤ªéƒ" />
      </div>

      <div class="field">
        <label for="contractEnd">â‘¡ å¥‘ç´„çµ‚äº†æ—¥</label>
        <input id="contractEnd" type="date" />
      </div>

      <div class="field">
        <label for="templateTypeRegister">â‘¢ ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥</label>
        <select id="templateTypeRegister">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="å¥‘ç´„æ›´æ–°">å¥‘ç´„æ›´æ–°</option>
          <option value="å˜ä¾¡å¤‰æ›´">å˜ä¾¡å¤‰æ›´</option>
          <option value="æƒ…å ±å¤‰æ›´">æƒ…å ±å¤‰æ›´</option>
        </select>
      </div>

      <button id="registerBtn" class="primary">ç™»éŒ²</button>
      <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
    </div>
    <div id="formMsg" style="margin-top:12px; font-size:12px; font-weight:700;"></div>
  </div>

  <div id="status">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>

  <div class="table-wrapper">
    <table id="reqTable"></table>
  </div>

  <div class="card mt14">
    <div class="card-title">ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆãã®å ´ã§ã‚³ãƒ”ãƒšç”¨ï¼‰</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
      <div class="field">
        <label for="templateType">ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥</label>
        <select id="templateType" style="width:100%;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="contract">å¥‘ç´„æ›´æ–°</option>
          <option value="rate">å˜ä¾¡å¤‰æ›´</option>
          <option value="info">æƒ…å ±å¤‰æ›´</option>
        </select>
      </div>
      <div class="field">
        <label for="templateKey">ãƒ†ãƒ³ãƒ—ãƒ¬é¸æŠ</label>
        <select id="templateKey" style="width:100%;">
          <option value="">ï¼ˆã¾ãšç¨®åˆ¥ã‚’é¸æŠï¼‰</option>
        </select>
      </div>
    </div>
    <div class="field" style="margin-top:16px;">
      <label for="templateBody">æ–‡é¢ï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</label>
      <textarea id="templateBody" rows="8" style="width:100%; box-sizing:border-box; resize: vertical;" readonly>ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰</textarea>
    </div>
    <button id="copyBtn" class="primary" style="width:100%; margin-top:16px; padding: 14px;">
      ã“ã®æ–‡é¢ã‚’ã‚³ãƒ”ãƒ¼
    </button>
  </div>

  <script>
    // ====== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
    function esc(v) {
      return String(v ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function fmtDate(v) { return v ? esc(String(v).slice(0, 10)) : ""; }
    function setStatus(message, isError) {
      const el = document.getElementById("status");
      el.classList.toggle("error", !!isError);
      el.textContent = message || "";
    }
    function setFormMsg(message, isError) {
      const el = document.getElementById("formMsg");
      el.style.color = isError ? "#d93025" : "#008a32";
      el.textContent = message || "";
    }
    function badge(text, ok) { return `<span class="${ok ? "badge badge-ok" : "badge"}">${esc(text)}</span>`; }

    // ====== å¸¸è¨­ãƒªãƒ³ã‚¯ï¼ˆLinksã‚·ãƒ¼ãƒˆé€£å‹•ï¼‰ ======
    const ICON_BY_LABEL = [
      { re: /å¥‘ç´„|æ›´æ–°|ã‚¹ãƒ—ã‚·/i, icon: "ğŸ“‹", hint: "æ›´æ–°ã®ç¢ºèª" },
      { re: /ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³|çŠ¶æ³/i, icon: "ğŸ“ˆ", hint: "çŠ¶æ³ãƒã‚§ãƒƒã‚¯" },
      { re: /ãƒã‚§ãƒƒã‚¯|ãƒªã‚¹ãƒˆ|æ‰‹ç¶šã/i, icon: "âœ…", hint: "æ‰‹ç¶šãæ‰‹é †" },
      { re: /slack|ã‚¹ãƒ©ãƒƒã‚¯|SW/i, icon: "ğŸ’¬", hint: "é€£çµ¡" },
      { re: /chat|ãƒãƒ£ãƒƒãƒˆ/i, icon: "ğŸ—¨ï¸", hint: "é€£çµ¡" },
      { re: /mail|ãƒ¡ãƒ¼ãƒ«/i, icon: "âœ‰ï¸", hint: "Gmail" },
      { re: /ãƒ•ã‚©ãƒ­ãƒ¼|follow/i, icon: "ğŸ‘¤", hint: "ãƒ•ã‚©ãƒ­ãƒ¼å°ç·š" },
      { re: /ãƒ€ãƒƒã‚·ãƒ¥|dashboard/i, icon: "ğŸ“Š", hint: "ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰" },
      { re: /notebook/i, icon: "ğŸ““", hint: "ãƒãƒ¼ãƒˆ" },
    ];
    function pickIconHint_(label) {
      const s = String(label ?? "");
      for (const it of ICON_BY_LABEL) {
        if (it.re.test(s)) return { icon: it.icon, hint: it.hint };
      }
      return { icon: "ğŸ”—", hint: "" };
    }

    function renderQuickLinks_(res) {
      const wrap = document.getElementById("quickLinks");
      wrap.innerHTML = "";

      if (!res || res.error) {
        wrap.innerHTML = `<div style="color:#d93025; font-size:12px; font-weight:700;">ãƒªãƒ³ã‚¯å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>`;
        return;
      }

      const links = Array.isArray(res.links) ? res.links : [];
      if (links.length === 0) {
        wrap.innerHTML = `<div style="color:#666; font-size:12px; font-weight:700;">ãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆLinksã‚·ãƒ¼ãƒˆã‚’ç¢ºèªï¼‰</div>`;
        return;
      }

      wrap.innerHTML = links.map((l) => {
        const meta = pickIconHint_(l.label);
        const url = esc(l.url);
        const label = esc(l.label);
        const hint = esc(meta.hint ?? "");
        const icon = esc(meta.icon ?? "ğŸ”—");
        return `
          <a class="quick-link" href="${url}" target="_blank" rel="noopener noreferrer">
            <div class="quick-link__visual">${icon}</div>
            <div class="quick-link__body">
              <span class="quick-link__label">${label}</span>
              <div class="quick-link__hint">${hint}</div>
            </div>
            <span class="quick-link__arrow" aria-hidden="true">â†—</span>
          </a>
        `;
      }).join("");
    }

    function loadQuickLinks_() {
      google.script.run
        .withSuccessHandler(renderQuickLinks_)
        .withFailureHandler(() => renderQuickLinks_({ links: [], error: "failed" }))
        .getLinksData();
    }

    // ====== Contractsä¸€è¦§è¡¨ç¤º ======
    function toObjects(headers, rows) {
      const idx = Object.fromEntries(headers.map((h, i) => [h, i]));
      return rows.map(r => ({
        staffName: r[idx["ã‚¹ã‚¿ãƒƒãƒ•å"]],
        contractEnd: r[idx["å¥‘ç´„çµ‚äº†æ—¥"]],
        status: r[idx["å¥‘ç´„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"]],
        templateType: r[idx["ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥"]],
        raiseRealized: r[idx["å˜ä¾¡UPå®Ÿç¾"]],
      }));
    }

    function renderRequirementTable(items) {
      const table = document.getElementById("reqTable");
      const thead = `<thead><tr><th>ã‚¹ã‚¿ãƒƒãƒ•å</th><th>å¥‘ç´„çµ‚äº†æ—¥</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ãƒ†ãƒ³ãƒ—ãƒ¬ç¨®åˆ¥</th><th>å˜ä¾¡UPå®Ÿç¾</th></tr></thead>`;
      if (!items || items.length === 0) {
        table.innerHTML = thead + `<tbody><tr><td colspan="5">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr></tbody>`;
        return;
      }
      const tbodyRows = items.map(it => {
        const staff = it.staffName ? esc(it.staffName) : badge("æœªè¨­å®š", false);
        const tmpl  = it.templateType ? esc(it.templateType) : badge("æœªè¨­å®š", false);
        const realized =
          it.raiseRealized === true ||
          it.raiseRealized === 1 ||
          String(it.raiseRealized).toLowerCase() === "true" ||
          String(it.raiseRealized) === "å®Ÿç¾";
        return `<tr>
          <td style="font-weight:700;">${staff}</td>
          <td>${fmtDate(it.contractEnd)}</td>
          <td>${esc(it.status)}</td>
          <td>${tmpl}</td>
          <td>${realized ? badge("å®Ÿç¾", true) : badge("æœª", false)}</td>
        </tr>`;
      }).join("");
      table.innerHTML = thead + `<tbody>${tbodyRows}</tbody>`;
    }

    function loadRequirementList() {
      setStatus("æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...", false);
      google.script.run
        .withSuccessHandler((res) => {
          if (!res || res.error) { setStatus("å–å¾—ã‚¨ãƒ©ãƒ¼", true); return; }
          renderRequirementTable(toObjects(res.headers || [], res.rows || []));
          setStatus("æœ€çµ‚æ›´æ–°: " + new Date().toLocaleTimeString(), false);
        })
        .withFailureHandler(() => setStatus("é€šä¿¡ã‚¨ãƒ©ãƒ¼", true))
        .getContractsData();
    }

    function setRegisterBusy(isBusy) {
      ["registerBtn", "reloadBtn", "staffName", "contractEnd", "templateTypeRegister"]
        .forEach(id => document.getElementById(id).disabled = isBusy);
    }

    function handleRegister() {
      const staffName = document.getElementById("staffName").value.trim();
      const contractEnd = document.getElementById("contractEnd").value;
      const templateType = document.getElementById("templateTypeRegister").value;
      if (!staffName || !contractEnd || !templateType) { setFormMsg("å…¥åŠ›ä¸è¶³ãŒã‚ã‚Šã¾ã™", true); return; }

      setRegisterBusy(true);
      setFormMsg("ç™»éŒ²ä¸­...", false);

      google.script.run
        .withSuccessHandler(() => {
          setFormMsg("ç™»éŒ²ã•ã‚Œã¾ã—ãŸ", false);
          ["staffName", "contractEnd", "templateTypeRegister"].forEach(id => document.getElementById(id).value = "");
          loadRequirementList();
          setRegisterBusy(false);
        })
        .withFailureHandler(() => {
          setFormMsg("ç™»éŒ²å¤±æ•—", true);
          setRegisterBusy(false);
        })
        .addContract(staffName, contractEnd, templateType);
    }

    // ====== Templatesï¼ˆã‚¹ãƒ—ã‚·é€£å‹•ï¼‰ ======
    let TEMPLATE_LIST = [];

    function resetTemplateUI_() {
      document.getElementById("templateKey").innerHTML = '<option value="">ï¼ˆã¾ãšç¨®åˆ¥ã‚’é¸æŠï¼‰</option>';
      document.getElementById("templateBody").value = "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰";
    }

    function loadTemplates_() {
      google.script.run
        .withSuccessHandler((res) => {
          if (!res || res.error) return;
          TEMPLATE_LIST = res.templates || [];
        })
        .withFailureHandler(() => { TEMPLATE_LIST = []; })
        .getTemplatesData();
    }

    function getTemplatesByType_(typeLabel) {
      return TEMPLATE_LIST.filter(t => t.template_type === typeLabel);
    }

    const typeSel = document.getElementById("templateType");
    const keySel  = document.getElementById("templateKey");
    const bodyEl  = document.getElementById("templateBody");
    const copyBtn = document.getElementById("copyBtn");

    typeSel.addEventListener("change", () => {
      const map = { contract: "å¥‘ç´„æ›´æ–°", rate: "å˜ä¾¡å¤‰æ›´", info: "æƒ…å ±å¤‰æ›´" };
      const list = getTemplatesByType_(map[typeSel.value]) || [];
      keySel.innerHTML =
        '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' +
        list.map(t => `<option value="${esc(t.template_key)}">${esc(t.label)}</option>`).join("");
      bodyEl.value = "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰";
    });

    keySel.addEventListener("change", () => {
      const tmpl = TEMPLATE_LIST.find(t => t.template_key === keySel.value);
      bodyEl.value = tmpl ? tmpl.body : "ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶ã¨ã“ã“ã«æ–‡é¢ãŒå‡ºã¾ã™ï¼‰";
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(bodyEl.value);
        const txt = copyBtn.textContent;
        copyBtn.textContent = "ã‚³ãƒ”ãƒ¼å®Œäº†ï¼";
        setTimeout(() => copyBtn.textContent = txt, 1500);
      } catch (e) {
        alert("ã‚³ãƒ”ãƒ¼å¤±æ•—");
      }
    });

    document.getElementById("reloadBtn").addEventListener("click", loadRequirementList);
    document.getElementById("registerBtn").addEventListener("click", handleRegister);

    window.addEventListener("DOMContentLoaded", () => {
      resetTemplateUI_();
      loadQuickLinks_();
      loadRequirementList();
      loadTemplates_();
    });
  </script>
</body>
</html>
