<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>契約詳細</title>
  <style>
    :root{
      --primary-blue:#4eb1e9;
      --hover-blue:#3a9dd4;
      --bg:#f9fbfe;
      --text:#333;
      --sub:#666;
      --border:#e1e8ed;
      --card:#fff;
      --thick:2px;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", "Hiragino Sans", Meiryo, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin:0;
      padding:16px;
      line-height:1.6;
    }
    .card{
      background:var(--card);
      border:var(--thick) solid var(--border);
      border-radius:12px;
      padding:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.05);
      margin-bottom:12px;
    }
    .title{
      font-weight:900;
      font-size:16px;
      margin:0 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      background:#e1f5fe;
      color:var(--primary-blue);
      border:1px solid var(--primary-blue);
      font-weight:800;
      font-size:12px;
      white-space:nowrap;
    }
    label{
      display:block;
      font-weight:800;
      font-size:12px;
      color:var(--sub);
      margin:10px 0 6px;
    }
    select, textarea, button{
      width:100%;
      box-sizing:border-box;
      border-radius:10px;
      border:var(--thick) solid var(--border);
      background:#fff;
      font-size:14px;
      padding:10px 12px;
      outline:none;
    }
    select:focus, textarea:focus{ border-color:var(--primary-blue); }
    textarea{ resize:vertical; min-height:180px; }
    button{
      cursor:pointer;
      font-weight:900;
      transition:all .2s;
    }
    button.primary{
      background:var(--primary-blue);
      border-color:var(--primary-blue);
      color:#fff;
    }
    button.primary:hover{ background:var(--hover-blue); border-color:var(--hover-blue); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .hint{ color:var(--sub); font-size:12px; font-weight:800; }
    .error{ color:#d93025; font-weight:900; font-size:12px; }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 760px){
      .row2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="card">
    <div class="title">
      <span>契約詳細（テンプレ生成）</span>
      <span id="typePill" class="pill">（判定中）</span>
    </div>
    <div class="hint">
      ※この画面は Templates シートの内容を表示します（ダミー文面なし）
    </div>
  </div>

  <div class="card">
    <div class="row2">
      <div>
        <label for="typeSel">テンプレ種別</label>
        <select id="typeSel">
          <option value="">選択してください</option>
          <option value="契約更新">契約更新</option>
          <option value="単価変更">単価変更</option>
          <option value="情報変更">情報変更</option>
        </select>
      </div>

      <div>
        <label for="tplSelect">テンプレ選択</label>
        <select id="tplSelect" disabled>
          <option value="">（まず種別を選択）</option>
        </select>
      </div>
    </div>

    <label for="tplBody">文面（コピー用）</label>
    <textarea id="tplBody" readonly>（テンプレを選ぶとここに文面が出ます）</textarea>

    <button id="copyBtn" class="primary" type="button" style="margin-top:12px;" disabled>
      この文面をコピー
    </button>

    <div id="msg" style="margin-top:10px;"></div>
  </div>

  <script>
    // ====== util ======
    function setMsg(text, isError){
      const el = document.getElementById("msg");
      el.className = isError ? "error" : "hint";
      el.textContent = text || "";
    }
    function setPill(label){
      document.getElementById("typePill").textContent = label || "（未選択）";
    }

    // ====== type from server template (GAS doGet で t.type を渡す) ======
    // "contract" / "rate" / "info" が来る想定。来なければ空扱い。
    const typeParam = "<?= type ?>";

    // 表示用：英→日（Indexと揃える）
    const TYPE_MAP = {
      contract: "契約更新",
      rate: "単価変更",
      info: "情報変更"
    };

    // ====== DOM ======
    const typeSel   = document.getElementById("typeSel");
    const tplSelect = document.getElementById("tplSelect");
    const tplBody   = document.getElementById("tplBody");
    const copyBtn   = document.getElementById("copyBtn");

    // ====== templates cache ======
    let TEMPLATE_LIST = [];

    function resetTplUI(){
      tplSelect.innerHTML = '<option value="">（まず種別を選択）</option>';
      tplSelect.disabled = true;
      tplBody.value = "（テンプレを選ぶとここに文面が出ます）";
      copyBtn.disabled = true;
    }

    function loadTemplates(){
      setMsg("テンプレ読込中...", false);
      google.script.run
        .withSuccessHandler((res) => {
          if (!res || res.error) {
            TEMPLATE_LIST = [];
            resetTplUI();
            setMsg("テンプレ取得に失敗しました（Templatesシート確認）", true);
            return;
          }
          TEMPLATE_LIST = res.templates || [];
          setMsg("", false);

          // URLパラメータで初期種別をセット（あれば）
          const initial = TYPE_MAP[typeParam] || "";
          if (initial) {
            typeSel.value = initial;
            setPill(initial);
            buildTplSelectByType_(initial);
          } else {
            setPill("（未選択）");
          }
        })
        .withFailureHandler(() => {
          TEMPLATE_LIST = [];
          resetTplUI();
          setMsg("通信エラー：テンプレ取得に失敗しました", true);
        })
        .getTemplatesData();
    }

    function buildTplSelectByType_(typeLabel){
      const list = TEMPLATE_LIST.filter(t => t.template_type === typeLabel);

      tplSelect.innerHTML =
        '<option value="">選択してください</option>' +
        list.map(t => `<option value="${String(t.template_key)}">${String(t.label)}</option>`).join("");

      tplSelect.disabled = false;
      tplBody.value = "（テンプレを選ぶとここに文面が出ます）";
      copyBtn.disabled = true;

      if (list.length === 0){
        tplSelect.innerHTML = '<option value="">（この種別のテンプレがありません）</option>';
        tplSelect.disabled = true;
        setMsg("この種別のテンプレが Templates にありません", true);
      } else {
        setMsg("", false);
      }
    }

    // ====== events ======
    typeSel.addEventListener("change", () => {
      const label = typeSel.value;
      setPill(label || "（未選択）");
      resetTplUI();
      if (!label) return;
      buildTplSelectByType_(label);
    });

    tplSelect.addEventListener("change", () => {
      const key = tplSelect.value;
      const tmpl = TEMPLATE_LIST.find(t => String(t.template_key) === String(key));
      tplBody.value = tmpl ? (tmpl.body || "") : "（テンプレを選ぶとここに文面が出ます）";
      copyBtn.disabled = !tmpl;
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(tplBody.value);
        const old = copyBtn.textContent;
        copyBtn.textContent = "コピー完了！";
        setTimeout(() => copyBtn.textContent = old, 1500);
      } catch (e) {
        alert("コピー失敗");
      }
    });

    // ====== start ======
    window.addEventListener("DOMContentLoaded", () => {
      resetTplUI();
      loadTemplates();
    });
  </script>
</body>
</html>
